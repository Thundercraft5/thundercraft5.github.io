import e from"chokidar";import{spawn as r}from"child_process";import"colors";import t from"path";import{promises as s,constants as o}from"fs";import{fileURLToPath as i}from"url";import n from"glob";import l from"express";import c from"morgan";import a from"http2";import m from"http2-express-bridge";import d from"https";import p from"spdy";import{INLINE as u,NONE as f,SELF as h,expressCspHeader as b}from"express-csp-header";function g(...e){console.log("[SERVER]".blue.bold,...e)}process.env.PORT;const y=m(l),$={cert:await s.readFile("./localhost.crt"),key:await s.readFile("./localhost.key"),allowHTTP1:!0};y.use(b({directives:{"default-src":["blob","data:",h],"script-src":["blob:",h,u],"style-src":["blob:",h,u],"img-src":["*"],"worker-src":[h,u,"blob:"],"block-all-mixed-content":!0}})),y.use(c(((e,r,t)=>{const s=e.method(r,t),o=e.url(r,t),i=e.status(r,t),n=(e.res(r,t,"content-length"),e["response-time"](r,t));g(`${s?.magenta||"<INVALID METHOD>".red.bold} ${i>=500?i.red.bold:i>=400?i.yellow.bold:i>=300?i.cyan.bold:i>=200?i.green.bold:0} ${`https://nkg-msi${o}`.blue} in ${n.magenta.bold}ms`)}))),y.get("/favicon.ico",((e,r)=>r.sendFile(t.resolve("./resources/images/favicon.ico")))),y.get("*",(async({url:e,headers:r},i,n)=>{const l=t.join(t.resolve("."),e),c=await async function(e){try{return await s.access(e,o.F_OK),!0}catch{return!1}}(l),a=r["sec-fetch-dest"],m=["style","script"].includes(a),d=t.extname(e),p=c?await s.stat(l):null;if(m&&c&&p?.isDirectory())return i.redirect(`${e}/index.${"style"===a?"css":"js"}`);if(c&&!d){if(p?.isDirectory())return e.endsWith("/")?i.sendFile(t.join(l,"index.html")):i.redirect(301,`${e}/`)}else{if(c)return i.sendFile(l);if(!d&&m)return i.redirect(301,`${e}.${"style"===a?"css":"js"}`)}return n()})),y.get("*",((e,r)=>r.status(900).sendFile(t.resolve("./404.html")))),y.use(((e,{url:r,method:s},o,i)=>{if("GET"!==s)return o.status(405).sendFile(t.resolve("./405.html"));try{decodeURIComponent(r)}catch(e){if(e instanceof URIError)return o.status(400).sendFile(t.resolve("./bad-request.html"))}console.log(e),o.status(500).sendFile(t.resolve("./500.html"))}));const v=a.createSecureServer($,y);function F(e,r){v.listen(e,r,(()=>{g(`listening on port ${r.green}:${e.toString().cyan}`)}))}F(443,"192.168.1.234"),F(443,"192.168.1.231"),g(`View your server at ${"https://nkg-msi".green.bold}`);